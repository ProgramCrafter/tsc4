() __test_replace_ad() {
  slice in = "00000000616161"s;
  slice out = "00000000646464"s;
  
  slice got = find_and_replace(0x61, 0x64,
      begin_cell().store_slice(in).end_cell()).begin_parse();
  throw_unless(130, got.slice_hash() == out.slice_hash());
}

() __test_replace_aadd() {
  slice in = "00000000616161"s;
  slice out = "00000000646461"s;
  
  slice got = find_and_replace(0x6161, 0x6464,
      begin_cell().store_slice(in).end_cell()).begin_parse();
  throw_unless(130, got.slice_hash() == out.slice_hash());
}

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

slice statement_in() asm "b{10100001011} b{10101000111111} |_ PUSHSLICE";
slice statement_out() asm "b{10100001111} b{11111000111111} |_ PUSHSLICE";
slice statement_true_out() asm "b{10100001111} b{11111000111111} |+ PUSHSLICE";

() __test_replace_statement() {
  slice out = statement_true_out();
  slice got = find_and_replace(0x175, 0x1FF,
      begin_cell().store_slice(statement_in()).end_cell()).begin_parse();
  throw_unless(130, got.slice_hash() == out.slice_hash());
}

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

slice multicell_57_in() asm "b{1} b{01} |_ PUSHSLICE";
slice multicell_57_out() asm "b{111} PUSHSLICE";

() __test_replace_multicell_57() {
  slice out = multicell_57_out();
  slice got = find_and_replace(5, 7,
      begin_cell().store_slice(multicell_57_in()).end_cell()).begin_parse();
  throw_unless(130, got.slice_hash() == out.slice_hash());
}

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

slice no_match_in() asm "b{100} b{01} |_ PUSHSLICE";
slice no_match_out() asm "b{10001} PUSHSLICE";

() __test_replace_no_match() {
  slice out = no_match_out();
  slice got = find_and_replace(15, 7,
      begin_cell().store_slice(no_match_in()).end_cell()).begin_parse();
  got~dump();
  throw_unless(130, got.slice_hash() == out.slice_hash());
}

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

slice rand_1_in() asm "x{39C0D7D664B15244AC2AB9B478454D714E90AF59905F8D4562E497A9A1B30D41911DCEC16916A69C3B07B6981B67B68BD126DB3508F8717E371976973B801F60B47809A0ACD8B3D6F0E48F8A3F689FDAF5AFE86EFC9AC0E16097587A2888EBBBC0687AF9D8A10B49D629A9BD688BF15270797A0DB97513C52EA7F396C2422D9} x{933D60B88937AB92E424656E04E2BFC9B07D41C9AE7F46E1D6FA00C62016D32C5A31810D121667028DDDEE3F701644BF8339C154B7F5CE116D5D00D6F6D72F3AED6C6FC6AF8F7ACE195505A0394A9FBE6811392AF6674507635098F566C2B33C6C6F4BC2E264240BF52F75EFC6450E2E73597B33FAF5603C1087D1D93B00506} x{320B5C611C7294909720B21A0E8AB299935E5E2ED8D6A82EEF11F912FEC74A960B1B39D20E6D5E00C023AE418EFA08347A9C8CAAFBF48C789377726DAF3DABD57B4DD9FB29302D2C308BFECD6F341750434E790B4EC0CA710DDD700E9633F5CABDCDE2A84ADA7F29DD9A89A6B0C084CA8CEF6FF6E6CD99CC025AF03F9F159C6} x{309064B63036576304310D5324ED7B4585849A8FE3498E3118C631435DFC94C4267E7E748BB7B50A7B58D6051D955D5E961F5A0E9A8F389AAEFCF93CD6B57825E8BAFC14E1E5F12DF6BD775A26EFBC434A89A0E7061DBEA3F21C4D9D31CE0FCBAEC4689C6DC32B81825214D8345BCAA9062F73CCDDA89B2E55F4DBC3F15179F} x{0074734EA40C878A0BA0797B993A83D847253851543FCA3376370D67A90C722CDB71A2753A42B165E5E085B4169FD7B64805E42CEB12408C1B27D4E226446E3012051F86EBDED060D81D9B41056CB6744A005FEACDDA608875FE17680BB68E6233B5D08E2D85447474432A8A6C2988102A86DCB60B6A47B19B4859B2E0FEE5E} |_ |_ |_ |_ PUSHSLICE";
slice rand_1_out() asm "x{39A00D7D664A815244AA02AB9B4740454D6814E90AF59905F40D45502E497A9A1B280D41911DCEA016916A69A03A807B69401B67B68BD126DB3508F406817D03681976973B4001F500B474009A0ACD40B3D6E80E48F40A3F689FDAF5AFE86EFC9AA00D01500975407A2888EBBBA00687AF9D40A10B49D5029A9BD688BE81526} x{80797A0DB97513A052EA7F396A02422D9933D500B408937AB92E424656D004D02BFC9A807D41C9AE7F46D01D6FA00A0502016D32A05A2814010D1216668028DDDED03F6801644BF40339A0154B7F5CD0116D5D00D6F6D72F3AED6A06FA06AF40F7ACD0195505A0394A9FBE6811392AF667450750350940F566A02B33A06A06F} x{4BA02D0264240BF52F75EFA06450D02E73597B33FAF55003A01087D1D93A8005050320B5A05011A07294909720B21A0E8AB299935E5D02ED40D6A82EEE811F912FEA074A9500A81B39D20E6D5D000A0023AE4140EFA08347A9C8CAAFBF48A07409377726DAF3DABD57B4DD9FB292802D2A02808BFECD6F341750434E790B4EA} x{00CA6810DDD6800E95033F5CABDCDD02A84ADA7F29DD9A89A6A80A0084CA8CEF6FF6E6CD99CA0025AE803F9E8159A0502809064B5028036575028042810D5324ED7B454054049A8FD034940D0281140A050281435DFC94A04267E7E748BB7B50A7B540D50051D955D5E9501F5A0E9A8F3409AAEFCF93CD6B574025E8BAFA014} x{D01E5E812DF6BD775A26EFBA0434A89A0E680501DBEA3F21A04D9D281CD00FCBAEA04689A06DA032B4014025214D40345BCAA90502F73CCDDA89B2E55F4DBA03E815179E80074734EA40C8740A0BA0797B993A83D40472534051543FCA337503680D67A90A0722CDB681A2753A42A8165E5D0085B4169FD7B64805E42CEA812} x{408A01B27D4D0226446D028012051F406EBDED0500D401D9B41056CB6744A005FEACDDA5008875FD017680BB68E50233B5D08D02D405447474432A8A6A029408102A86DCB500B6A47A819B4859B2D00FEE5E} |_ |_ |_ |_ |_ PUSHSLICE";

() __test_replace_rand_1() {
  slice out = rand_1_out();
  slice got = find_and_replace(24, 320,
      begin_cell().store_slice(rand_1_in()).end_cell()).begin_parse();
  got~dump();
  throw_unless(130, got.slice_hash() == out.slice_hash());
}

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

slice amplify_5100b_in() asm "x{FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF} dup dup dup dup |_ |_ |_ |_ PUSHSLICE";

() __test_replace_amplify_8_5100b() {
  slice in = amplify_5100b_in();
  slice got = find_and_replace(1, 0xFF,
      begin_cell().store_slice(in).end_cell()).begin_parse();
  got~impure_touch();
}

() __test_replace_amplify_128_5100b() {
  slice in = amplify_5100b_in();
  slice got = find_and_replace(1, (1 << 128) - 1,
      begin_cell().store_slice(in).end_cell()).begin_parse();
  got~impure_touch();
}

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; () __test_replace_amplify_8_1020b() {
;;   slice in = "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"s;
;;   slice got = find_and_replace(1, 0xFF,
;;       begin_cell().store_slice(in).end_cell()).begin_parse();
;;   got~impure_touch();
;; }
;; 
;; () __test_replace_amplify_128() {
;;   slice in = "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"s;
;;   slice got = find_and_replace(1, (1 << 128) - 1,
;;       begin_cell().store_slice(in).end_cell()).begin_parse();
;;   got~impure_touch();
;; }
;; 
;; () __test_replace_deamplify_128() {
;;   slice in = "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"s;
;;   slice got = find_and_replace((1 << 128) - 1, 1,
;;       begin_cell().store_slice(in).end_cell()).begin_parse();
;;   got~impure_touch();
;; }
